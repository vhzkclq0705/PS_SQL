```sql
-- Lv.4
-- 자동차 대여 기록 별 대여 금액 구하기

WITH trucks AS (
    SELECT
        car_id,
        car_type,
        daily_fee
    FROM car_rental_company_car
    WHERE car_type = '트럭'
),
history_duration AS (
    SELECT
        history_id,
        car_id,
        DATEDIFF(end_date, start_date) + 1 AS duration
    FROM car_rental_company_rental_history
    WHERE car_id IN (
        SELECT car_id
        FROM trucks
    )
),
total_fee AS (
    SELECT
        a.history_id,
        a.duration,
        a.duration * b.daily_fee AS fee
    FROM history_duration a
    JOIN trucks b ON a.car_id = b.car_id
),
num_discount AS (
    SELECT
        CAST(REGEXP_REPLACE(duration_type, '[^0-9]', '') AS UNSIGNED) AS duration_type,
        CAST(REGEXP_REPLACE(discount_rate, '[^0-9]', '') AS UNSIGNED) / 100 AS discount_rate
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE car_type = '트럭'
)

SELECT
    a.history_id,
    FLOOR(a.fee * (1 - COALESCE(MAX(b.discount_rate), 0))) AS fee
FROM total_fee a
LEFT JOIN num_discount b ON a.duration >= b.duration_type
GROUP BY a.history_id, a.fee
ORDER BY fee DESC, a.history_id DESC;
```